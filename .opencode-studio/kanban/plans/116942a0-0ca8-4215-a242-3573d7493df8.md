# Implementation Plan: Transition Test

**Task ID**: 116942a0-0ca8-4215-a242-3573d7493df8  
**Title**: Transition Test  
**Description**: Testing status transitions  
**Created**: 2025-12-31T19:55:51Z

## Technical Analysis

### Current State Assessment

OpenCode Studio implements a comprehensive task lifecycle state machine with 7 distinct states:

```
TODO → PLANNING → PLANNING_REVIEW → IN_PROGRESS → AI_REVIEW → REVIEW → DONE
```

**Existing Infrastructure:**
- **State Machine**: `crates/orchestrator/src/state_machine.rs` - Full transition validation logic
- **API Endpoints**: `crates/server/src/routes/tasks.rs` - `/api/tasks/{id}/transition` endpoint
- **Domain Models**: `crates/core/src/domain/task.rs` - TaskStatus enum with serialization
- **Event System**: SSE events for `task.status_changed` notifications
- **Current Tests**: 4 basic state machine unit tests (transition validation)

**Gaps Identified:**
1. **Missing Integration Tests**: No end-to-end API testing for transitions
2. **Insufficient Edge Case Coverage**: Limited testing of error scenarios
3. **No Concurrency Testing**: Parallel transition attempts untested
4. **Missing Event Validation**: SSE event emission not verified
5. **No Database State Testing**: Task persistence during transitions not validated

### Technical Dependencies

- **Core Crates**: `opencode_core`, `orchestrator`, `server`, `db`, `events`
- **Testing Infrastructure**: Standard Rust `#[cfg(test)]` inline modules
- **API Framework**: Axum with OpenAPI/utoipa integration
- **Database**: SQLite with sqlx (async ORM)
- **Event Bus**: tokio::broadcast for SSE events

## Files to Modify/Create

### New Test Files
1. **`crates/orchestrator/src/state_machine_integration_tests.rs`**
   - Comprehensive integration tests for state machine
   - Multi-step transition sequences
   - Error condition testing

2. **`crates/server/src/routes/tasks_integration_tests.rs`**
   - HTTP API endpoint testing
   - Request/response validation
   - Authentication/authorization edge cases

3. **`crates/db/src/repositories/task_repository_transition_tests.rs`**
   - Database persistence during transitions
   - Concurrent update scenarios
   - Transaction isolation testing

### Modified Existing Files
1. **`crates/orchestrator/src/state_machine.rs`**
   - Expand existing unit tests
   - Add property-based testing
   - Include stress testing scenarios

2. **`crates/server/src/routes/tasks.rs`**
   - Enhance error handling validation
   - Add transition logging verification
   - Improve event emission testing

3. **`crates/core/src/domain/task.rs`**
   - Add helper methods for test data generation
   - Include transition history tracking (if needed)

## Step-by-Step Implementation

### Phase 1: Enhanced Unit Testing (1-2 hours)
1. **Expand State Machine Tests**
   - Add comprehensive transition matrix validation
   - Test all valid forward/backward transitions
   - Validate all invalid transition rejections
   - Add edge cases (same-state transitions, null checks)

2. **Property-Based Testing**
   - Generate random transition sequences
   - Verify state machine invariants
   - Test transition idempotency where applicable

### Phase 2: Integration Testing (2-3 hours)
3. **API Integration Tests**
   - Create test harness for HTTP endpoints
   - Test complete transition workflows (TODO→DONE)
   - Validate JSON serialization/deserialization
   - Test error response formats and HTTP status codes

4. **Database Integration Tests**
   - Test task persistence during transitions
   - Verify `updated_at` timestamp changes
   - Test transaction rollback on failures
   - Validate concurrent transition attempts

### Phase 3: Event System Testing (1-2 hours)
5. **SSE Event Validation**
   - Verify `TaskStatusChanged` events are emitted
   - Test event payload format and content
   - Validate event delivery timing
   - Test event subscription/unsubscription

6. **Event Bus Integration**
   - Test event propagation across modules
   - Verify event ordering guarantees
   - Test event delivery failure scenarios

### Phase 4: End-to-End Workflow Testing (2-3 hours)
7. **Complete Lifecycle Tests**
   - Test full TODO→DONE automation flow
   - Include OpenCode session integration
   - Test human approval workflows
   - Validate file generation (plans, reviews)

8. **Error Recovery Testing**
   - Test transition failures and rollbacks
   - Validate system state consistency
   - Test retry mechanisms
   - Error logging and monitoring verification

### Phase 5: Performance & Stress Testing (1-2 hours)
9. **Concurrency Testing**
   - Multiple simultaneous transitions on different tasks
   - Race condition detection
   - Database lock testing
   - Event bus throughput validation

10. **Load Testing**
    - High-frequency transition requests
    - Memory usage monitoring
    - Database connection pool testing
    - SSE connection scaling

## Potential Risks

### High Risk
- **Database Corruption**: Concurrent transitions could corrupt task state
- **Event Loss**: SSE events might be lost during high load
- **State Inconsistency**: Orchestrator and database could diverge

### Medium Risk
- **Test Flakiness**: Async nature might cause intermittent test failures
- **Performance Degradation**: New tests might slow CI pipeline
- **Mock Complexity**: OpenCode client mocking might be complex

### Low Risk
- **Test Maintenance**: Additional tests require ongoing maintenance
- **Code Coverage**: Might reveal gaps in existing code coverage

## Mitigation Strategies

1. **Database Safety**
   - Use database transactions for multi-step operations
   - Implement proper locking mechanisms
   - Add comprehensive rollback testing

2. **Event Reliability**
   - Implement event persistence for critical events
   - Add retry mechanisms for event delivery
   - Test event ordering guarantees

3. **Test Stability**
   - Use deterministic test data
   - Implement proper async test patterns
   - Add timeout handling for long-running tests

4. **Performance Monitoring**
   - Add benchmarks for critical paths
   - Monitor test execution time
   - Implement parallel test execution where safe

## Success Criteria

### Functional Requirements
- ✅ All valid transitions work correctly
- ✅ All invalid transitions are properly rejected
- ✅ Events are emitted for all status changes
- ✅ Database state remains consistent
- ✅ API responses are correctly formatted

### Quality Requirements
- ✅ Test coverage >95% for transition-related code
- ✅ All tests complete within 30 seconds
- ✅ Zero flaky test failures
- ✅ Clean `cargo clippy` and `cargo fmt` output

### Performance Requirements
- ✅ Single transition completes within 100ms
- ✅ 100 concurrent transitions complete within 5 seconds
- ✅ Memory usage remains stable during stress tests

## Estimated Complexity: **MEDIUM (M)**

### Justification
- **Scope**: Focused on existing functionality, not new features
- **Technical Depth**: Requires understanding of multiple system components
- **Integration Complexity**: Must test across database, API, and event systems
- **Time Estimate**: 8-12 hours total development time
- **Risk Level**: Medium due to concurrency and state management concerns

### Complexity Breakdown
- **State Machine Logic**: Simple (well-defined state transitions)
- **API Testing**: Medium (HTTP integration complexity)
- **Database Testing**: Medium (transaction and concurrency concerns)
- **Event Testing**: Medium (async event propagation)
- **Integration Testing**: Complex (multiple system components)

## Implementation Notes

### Testing Strategy
- Prefer integration tests over mocking where possible
- Use real SQLite database for persistence testing
- Mock only external dependencies (OpenCode API)
- Implement proper test isolation and cleanup

### Code Quality
- Follow existing project conventions (inline `#[cfg(test)]` modules)
- Maintain clippy compliance (`-D warnings`)
- Use proper error handling (`Result<T, E>` patterns)
- Include comprehensive documentation for complex test scenarios

### Future Considerations
- Consider adding transition audit logging
- Evaluate need for transition rate limiting
- Plan for eventual transition webhooks/notifications
- Consider adding transition analytics/metrics

---

**Plan Status**: Ready for Implementation  
**Next Step**: Begin Phase 1 - Enhanced Unit Testing  
**Estimated Total Time**: 8-12 hours