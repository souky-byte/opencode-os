# Implementation Plan: Test SSE Activity

**Task ID:** 4db84480-2f92-48ee-9592-2c73beef95d3  
**Title:** Test SSE Activity  
**Description:** Test if session activity SSE works  
**Created:** 2026-01-01 01:36:13  

## 1. Technical Analysis

### Current SSE Infrastructure
- **Backend:** Axum-based SSE endpoints with `EventBuffer` for reconnection support
- **Frontend:** React hooks (`useEventStream`, `useSessionActivitySSE`) for SSE consumption
- **Target Endpoint:** `/api/sessions/{id}/activity` - currently returning empty in tests
- **Event Types:** `task.status_changed`, `session.started`, `session.ended`, session activity messages

### Known Issues from Previous Testing
- `/api/sessions/{id}/activity` endpoint returned empty during E2E testing
- Task execution timeout after 30 seconds causing status discrepancies
- SSE events for task status changes confirmed working at global level

### Testing Scope
1. **Backend SSE Generation:** Verify activity messages are properly created and queued
2. **SSE Transport:** Test the HTTP SSE stream delivery mechanism  
3. **Frontend Consumption:** Verify React hooks receive and process SSE data
4. **Event Buffering:** Test reconnection scenarios and message replay
5. **Real-time Updates:** Confirm UI updates in response to SSE events

## 2. Files to Examine/Modify

### Backend Files to Examine
```
crates/server/src/routes/sessions.rs           # SSE endpoint implementation
crates/events/src/bus.rs                       # Event emission system
crates/events/src/types.rs                     # Event type definitions  
crates/orchestrator/src/executor.rs            # Activity generation during task execution
crates/orchestrator/src/activity_store.rs      # Activity message storage/retrieval
crates/server/src/routes/events.rs             # Global SSE endpoint (working baseline)
```

### Frontend Files to Examine
```
frontend/src/hooks/useSessionActivitySSE.ts    # Session-specific SSE hook
frontend/src/hooks/useEventStream.ts           # Generic SSE stream hook
frontend/src/components/activity/ActivityFeed.tsx        # Activity display component
frontend/src/components/activity/ActivityItem.tsx        # Individual activity rendering
frontend/src/components/sessions/SessionCard.tsx         # Session UI with activity
frontend/src/components/task-detail/TaskDetailPanel.tsx  # Task detail with activity
```

### Test Files to Create
```
crates/server/tests/integration_sse_activity.rs     # Backend SSE integration test
frontend/src/__tests__/sse-activity.test.tsx        # Frontend SSE hook tests
test-scripts/manual-sse-test.js                     # Manual browser testing script
```

## 3. Step-by-Step Implementation Steps

### Phase 1: Backend Activity Generation Verification (2 hours)
1. **Trace Activity Creation Path**
   - Add debug logging to `executor.rs` activity generation
   - Verify activity messages are created during task execution
   - Check `activity_store.rs` for proper message persistence

2. **Test Activity Storage**
   - Create unit test for activity message creation
   - Verify database storage of session activities
   - Test activity retrieval by session ID

3. **Debug SSE Endpoint**
   - Add logging to `/api/sessions/{id}/activity` route
   - Test endpoint manually with curl/browser
   - Verify EventBuffer is populated with session activities

### Phase 2: SSE Transport Testing (1 hour)
1. **Manual SSE Testing**
   - Create test session with known activities
   - Connect to SSE endpoint via browser/curl
   - Verify SSE headers and connection establishment
   - Test message format and Content-Type

2. **Integration Test Development**
   - Create Axum test client for SSE endpoint testing
   - Test SSE connection lifecycle (connect, receive, disconnect)
   - Verify proper EventBuffer behavior and message ordering

### Phase 3: Frontend SSE Hook Testing (2 hours)
1. **Hook Isolation Testing**
   - Unit test `useSessionActivitySSE` hook
   - Mock SSE EventSource behavior
   - Test reconnection logic and error handling
   - Verify activity message parsing

2. **Component Integration Testing**
   - Test ActivityFeed component with mock SSE data
   - Verify real-time UI updates
   - Test activity message rendering and formatting

### Phase 4: End-to-End Testing (2 hours)
1. **Live System Testing**
   - Start backend server with debug logging
   - Create test task and execute it
   - Monitor SSE connections in browser DevTools
   - Verify activity messages flow through the system

2. **Edge Case Testing**
   - Test SSE reconnection after network interruption
   - Verify activity history replay for new connections
   - Test multiple concurrent SSE connections
   - Verify activity filtering by session ID

### Phase 5: Performance & Reliability Testing (1 hour)
1. **Load Testing**
   - Test multiple sessions with concurrent activity
   - Verify EventBuffer memory usage and cleanup
   - Test SSE connection limits and scaling

2. **Error Scenario Testing**
   - Test behavior with invalid session IDs
   - Verify graceful handling of SSE connection failures
   - Test activity generation during OpenCode errors

## 4. Potential Risks

### High Risk
- **EventBuffer Memory Leaks:** Improper cleanup of session activity buffers could cause memory growth
- **SSE Connection Exhaustion:** Browser/server connection limits could block new SSE connections
- **Activity Generation Timing:** Race conditions between OpenCode execution and activity creation

### Medium Risk  
- **Cross-Browser SSE Compatibility:** Edge cases with EventSource implementation differences
- **Network Interruption Handling:** SSE reconnection failures in unstable network conditions
- **Activity Message Ordering:** Out-of-order delivery affecting UI state consistency

### Low Risk
- **SSE Payload Size Limits:** Large activity messages exceeding SSE practical limits
- **CORS Configuration:** SSE-specific CORS requirements not properly configured
- **Content-Type Issues:** Improper SSE headers causing client connection failures

## 5. Success Criteria

- [ ] `/api/sessions/{id}/activity` endpoint returns live activity messages
- [ ] Frontend receives and displays activity updates in real-time
- [ ] SSE reconnection works properly after network interruption
- [ ] Activity history is properly replayed on new connections
- [ ] No memory leaks or connection exhaustion under normal load
- [ ] Integration tests pass for SSE activity functionality
- [ ] Manual E2E test demonstrates working activity feed

## 6. Estimated Complexity

**Size: M (Medium)**

**Reasoning:**
- **Not a new feature implementation** - SSE infrastructure already exists
- **Primarily debugging/testing focused** - identifying why activity SSE isn't working
- **Well-defined scope** - specific to session activity SSE functionality
- **Moderate complexity** - involves backend event generation, SSE transport, and frontend consumption
- **Limited file changes expected** - mainly debugging, logging, and test additions

**Time Estimate: 8 hours**
- Backend verification: 3 hours
- Frontend testing: 2 hours  
- E2E testing: 2 hours
- Documentation/cleanup: 1 hour

## 7. Dependencies & Prerequisites

- Backend server running with SSE endpoints enabled
- Frontend development environment with React testing setup
- Access to browser DevTools for SSE connection monitoring
- Ability to create test sessions and execute OpenCode tasks
- Database access for activity storage verification

## 8. Deliverables

1. **Working SSE Activity Stream** - Live activity updates in browser
2. **Integration Test Suite** - Automated tests for SSE activity functionality  
3. **Debug Documentation** - Findings from SSE investigation and fixes applied
4. **Manual Test Script** - Reproducible test procedure for SSE activity verification