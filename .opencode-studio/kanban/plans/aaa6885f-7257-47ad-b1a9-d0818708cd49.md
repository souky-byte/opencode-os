# Implementation Plan: SSE Test 2

## Task Overview
- **Title:** SSE Test 2
- **Description:** test
- **Type:** Testing/Verification
- **Priority:** Medium

## Technical Analysis

### Context
This task appears to be a follow-up test for the Server-Sent Events (SSE) functionality in OpenCode Studio. The system has recently migrated from WebSocket to SSE for real-time communication, and previous testing revealed some issues that need verification.

### Current SSE Infrastructure
- **Backend SSE Endpoints:**
  - `/api/events` - Global SSE event stream
  - `/api/sessions/{id}/activity` - Per-session activity stream
- **Frontend Hooks:**
  - `useEventStream` - Global events with auto-reconnect
  - `useSessionActivitySSE` - Session-specific activity with history replay
- **Event Types:**
  - `task.status_changed` - Task lifecycle updates
  - `session.started` - OpenCode session initialization
  - `session.ended` - OpenCode session completion
  - Activity messages for ongoing session operations

### Known Issues from Previous Testing
1. `/api/sessions/{id}/activity` endpoint returning empty responses
2. Potential task status synchronization issues between Studio DB and OpenCode
3. 30-second timeout on `/api/tasks/{id}/execute` endpoint
4. Need to verify SSE reconnection and history replay functionality

## Files to Modify/Create

### Test Files to Create
1. **`tests/integration/sse_integration_test.rs`** - Comprehensive SSE integration tests
2. **`frontend/src/__tests__/hooks/useEventStream.test.ts`** - Frontend SSE hook tests
3. **`frontend/src/__tests__/hooks/useSessionActivitySSE.test.ts`** - Session activity hook tests

### Files to Potentially Modify
1. **`crates/server/src/routes/events.rs`** - Event stream endpoint (if issues found)
2. **`crates/server/src/routes/sessions.rs`** - Session activity endpoint (if fixes needed)
3. **`crates/events/src/bus.rs`** - Event bus logic (if event propagation issues)
4. **`frontend/src/hooks/useEventStream.ts`** - Global event stream hook (if improvements needed)
5. **`frontend/src/hooks/useSessionActivitySSE.ts`** - Session activity hook (if fixes required)

### Configuration/Documentation
1. **Update test documentation in relevant README files**
2. **Add SSE testing guidelines to AGENTS.md if patterns are established**

## Step-by-Step Implementation Steps

### Phase 1: Backend SSE Testing (2-3 hours)
1. **Create integration test framework**
   - Set up test client for SSE connections
   - Create helper functions for event assertion
   - Test connection establishment and basic event flow

2. **Test global events endpoint (`/api/events`)**
   - Verify connection establishment
   - Test event broadcasting for task status changes
   - Test session lifecycle events (started/ended)
   - Verify event format and JSON serialization

3. **Test session activity endpoint (`/api/sessions/{id}/activity`)**
   - Create test session and verify activity stream
   - Test real-time activity message propagation
   - Verify session-specific filtering
   - Test behavior with non-existent session IDs

4. **Test reconnection and buffering**
   - Verify EventBuffer functionality for missed events
   - Test client disconnect/reconnect scenarios
   - Validate event ordering and deduplication

### Phase 2: Frontend SSE Testing (2-3 hours)
1. **Test useEventStream hook**
   - Mock SSE connection and verify hook behavior
   - Test auto-reconnect functionality
   - Verify proper cleanup on unmount
   - Test error handling and retry logic

2. **Test useSessionActivitySSE hook**
   - Verify session-specific event filtering
   - Test history replay functionality
   - Test real-time activity updates
   - Verify proper subscription management

3. **Integration testing with backend**
   - Test end-to-end event flow from backend to frontend
   - Verify proper React state updates
   - Test multiple concurrent connections

### Phase 3: Task Lifecycle Integration Testing (2-4 hours)
1. **Test complete task execution flow**
   - Create task via API
   - Execute task and monitor SSE events
   - Verify status transitions via SSE
   - Confirm session activity stream updates

2. **Test edge cases**
   - Task execution failures
   - Network interruptions during execution
   - Concurrent task operations
   - Session timeout scenarios

3. **Performance testing**
   - Test with multiple concurrent SSE connections
   - Verify memory usage with EventBuffer
   - Test event throughput under load

### Phase 4: Documentation and Cleanup (1 hour)
1. **Document test patterns and findings**
2. **Update AGENTS.md with SSE testing guidelines**
3. **Clean up any temporary test utilities**
4. **Ensure all tests pass in CI/CD pipeline**

## Potential Risks

### High Risk
- **Event loss during reconnection**: If EventBuffer isn't working correctly, clients might miss critical events
- **Memory leaks**: Improper SSE connection cleanup could cause server memory issues
- **Race conditions**: Concurrent task operations might cause event ordering issues

### Medium Risk
- **Frontend state synchronization**: React state updates from SSE events might cause rendering issues
- **Authentication in SSE**: Long-lived SSE connections might face auth token expiration
- **Cross-browser compatibility**: SSE implementation might behave differently across browsers

### Low Risk
- **Test environment setup**: Integration tests might require specific database states
- **Mock complexity**: Frontend tests might need complex SSE mocking
- **Documentation drift**: Test documentation might become outdated

## Mitigation Strategies

1. **For event loss**: Implement comprehensive integration tests that verify EventBuffer behavior
2. **For memory leaks**: Add monitoring and stress tests for SSE connections
3. **For race conditions**: Use proper event sequencing and add concurrent operation tests
4. **For state sync**: Test React state updates thoroughly with SSE event mocks
5. **For auth issues**: Test SSE connections with token refresh scenarios

## Success Criteria

- [ ] All SSE endpoints respond correctly with proper event formatting
- [ ] Frontend hooks handle SSE events reliably with proper state updates
- [ ] Event buffering and reconnection work as expected
- [ ] Complete task lifecycle generates appropriate SSE events
- [ ] No memory leaks or connection issues under normal load
- [ ] All integration tests pass consistently
- [ ] Documentation updated with testing patterns

## Estimated Complexity: **M (Medium)**

**Justification:**
- **Moderate scope**: Testing existing SSE infrastructure rather than building new features
- **Known domain**: SSE patterns are well-established, testing approaches are standard
- **Existing codebase**: Building on completed SSE migration work
- **Clear requirements**: Verification of known functionality with specific issue areas identified
- **Manageable risk**: Issues are likely configuration or edge-case related rather than architectural

**Time Estimate:** 6-10 hours total
- Backend testing: 2-3 hours
- Frontend testing: 2-3 hours  
- Integration testing: 2-4 hours
- Documentation: 1 hour

## Notes

- This test should focus on validating the completed SSE migration rather than implementing new features
- Pay special attention to the session activity endpoint which showed issues in previous testing
- Consider adding automated tests to prevent regression of SSE functionality
- The "test" description suggests this might be exploratory - be prepared to expand scope based on findings