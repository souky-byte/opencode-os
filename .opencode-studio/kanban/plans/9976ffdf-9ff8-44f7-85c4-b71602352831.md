# SSE Test 3 - Implementation Plan

## Task Overview
**Title:** SSE Test 3  
**Description:** test  
**Complexity:** M (Medium)  
**Estimated Time:** 4-6 hours

## Technical Analysis

### Context
This is the third iteration of Server-Sent Events (SSE) testing for OpenCode Studio. Previous tests identified several issues:

1. `/api/sessions/{id}/activity` endpoint returning empty responses
2. `POST /api/tasks/{id}/execute` timing out after 30 seconds
3. Task status discrepancies between OpenCode completion and Studio DB
4. Need for comprehensive real-time event verification

### Current SSE Infrastructure Status
- âœ… Backend SSE Infrastructure (Feature 1) - Complete
- âœ… Frontend SSE Hooks (Feature 2) - Complete  
- âœ… Backend Activity Message Serialization (Feature 3) - Complete
- ğŸ”„ WebSocket Code Cleanup (Feature 4) - In progress
- â³ Documentation & Testing (Feature 5) - Pending

### Test Objectives
Based on the migration status and previous test results, this test should focus on:

1. **Session Activity Stream Validation** - Fix empty activity responses
2. **Task Lifecycle Event Integrity** - Ensure real-time status updates work end-to-end
3. **SSE Connection Resilience** - Test auto-reconnect and event replay
4. **Frontend Hook Integration** - Verify `useEventStream` and `useSessionActivitySSE`
5. **Load Testing** - Multiple concurrent SSE connections

## Files to Modify/Create

### Test Files to Create
```
tests/integration/
â”œâ”€â”€ sse_test_3.rs                 # Main integration test
â”œâ”€â”€ helpers/
â”‚   â”œâ”€â”€ sse_client.rs            # SSE client for testing
â”‚   â””â”€â”€ task_lifecycle_helper.rs  # Task creation/execution helpers
â””â”€â”€ fixtures/
    â””â”€â”€ test_tasks.json          # Test task definitions
```

### Files to Potentially Modify
```
crates/server/src/
â”œâ”€â”€ routes/sessions.rs           # Session activity endpoint fixes
â”œâ”€â”€ routes/events.rs            # Global SSE endpoint improvements  
â””â”€â”€ routes/tasks.rs             # Task execution timeout handling

crates/orchestrator/src/
â”œâ”€â”€ executor.rs                 # Event emission during task execution
â””â”€â”€ activity_store.rs           # Activity message persistence

crates/events/src/
â”œâ”€â”€ bus.rs                      # Event bus reliability improvements
â””â”€â”€ types.rs                    # Event type definitions

frontend/src/
â”œâ”€â”€ hooks/useEventStream.ts     # Connection resilience testing
â”œâ”€â”€ hooks/useSessionActivitySSE.ts  # Session-specific SSE testing
â””â”€â”€ __tests__/
    â””â”€â”€ sse-hooks.test.tsx      # Frontend hook unit tests
```

## Step-by-Step Implementation

### Phase 1: Diagnostic Investigation (1-2 hours)
1. **Reproduce Previous Issues**
   - Set up task execution with SSE monitoring
   - Capture network traffic for `/api/sessions/{id}/activity`
   - Document exact failure scenarios

2. **Activity Store Audit**
   - Verify `ActivityStore` is properly storing session messages
   - Check database state after task execution
   - Validate event emission timing

3. **SSE Endpoint Analysis**
   - Test `/api/events` global stream
   - Test `/api/sessions/{id}/activity` per-session stream
   - Verify EventBuffer functionality

### Phase 2: Backend Fixes (1-2 hours)
1. **Session Activity Endpoint Fix**
   ```rust
   // In crates/server/src/routes/sessions.rs
   async fn get_session_activity(
       Path(session_id): Path<Uuid>,
       State(app_state): State<AppState>,
   ) -> Result<impl IntoResponse, AppError> {
       // Fix: Ensure activity messages are properly retrieved
       // Fix: Verify SSE formatting of activity events
   }
   ```

2. **Task Execution Timeout Handling**
   ```rust
   // In crates/server/src/routes/tasks.rs
   async fn execute_task(
       Path(task_id): Path<Uuid>,
       State(app_state): State<AppState>,
   ) -> Result<impl IntoResponse, AppError> {
       // Fix: Implement proper async task execution
       // Fix: Return immediately with 202 Accepted
       // Fix: Use background processing for long-running tasks
   }
   ```

3. **Event Emission Verification**
   ```rust
   // In crates/orchestrator/src/executor.rs
   // Ensure proper event emission at each lifecycle stage:
   // - task.status_changed (TODO â†’ PLANNING â†’ IN_PROGRESS â†’ etc.)
   // - session.started
   // - session.activity (for each OpenCode interaction)
   // - session.completed
   ```

### Phase 3: Comprehensive Integration Test (1-2 hours)
1. **Create SSE Test Client**
   ```rust
   // tests/integration/helpers/sse_client.rs
   struct SSETestClient {
       client: reqwest::Client,
       base_url: String,
   }

   impl SSETestClient {
       async fn connect_global_stream(&self) -> SSEStream;
       async fn connect_session_stream(&self, session_id: Uuid) -> SSEStream;
       async fn wait_for_event(&mut self, event_type: &str, timeout: Duration) -> Option<Event>;
   }
   ```

2. **Full Task Lifecycle Test**
   ```rust
   // tests/integration/sse_test_3.rs
   #[tokio::test]
   async fn test_complete_task_lifecycle_with_sse() {
       // 1. Connect to global SSE stream
       // 2. Create a test task
       // 3. Execute task (non-blocking)
       // 4. Monitor SSE events for:
       //    - task.status_changed events
       //    - session.started event  
       //    - session.activity events
       //    - session.completed event
       // 5. Verify final task status in database
       // 6. Verify session activity history
   }
   ```

3. **Concurrent Connection Test**
   ```rust
   #[tokio::test]
   async fn test_multiple_concurrent_sse_connections() {
       // Test 5-10 concurrent SSE connections
       // Verify all receive the same events
       // Test connection drops and reconnects
   }
   ```

### Phase 4: Frontend Integration Verification (30-60 minutes)
1. **Hook Testing**
   ```typescript
   // frontend/src/__tests__/sse-hooks.test.tsx
   describe('SSE Hooks', () => {
     test('useEventStream handles reconnection', () => {
       // Test auto-reconnect functionality
     });
     
     test('useSessionActivitySSE receives activity events', () => {
       // Test session-specific activity stream
     });
   });
   ```

2. **Manual Browser Testing**
   - Open developer tools Network tab
   - Execute a task through the UI
   - Verify SSE connections in Network tab
   - Verify real-time UI updates

### Phase 5: Documentation and Cleanup (30 minutes)
1. **Update Test Documentation**
   - Document test results in AGENTS.md
   - Update SSE migration status
   - Note any remaining issues

2. **Clean Up Test Artifacts**
   - Remove temporary test files if needed
   - Ensure no test data pollution in database

## Potential Risks

### High Risk
1. **Activity Store Race Conditions**
   - Risk: Events emitted before ActivityStore is ready
   - Mitigation: Add proper synchronization and event ordering

2. **Database Transaction Issues**
   - Risk: Task status updates in separate transactions causing inconsistency
   - Mitigation: Use database transactions properly for state changes

### Medium Risk
1. **SSE Connection Limits**
   - Risk: Too many concurrent connections could overwhelm server
   - Mitigation: Implement connection limits and graceful degradation

2. **Event Message Size**
   - Risk: Large activity messages could cause SSE performance issues
   - Mitigation: Implement message size limits and pagination

### Low Risk
1. **Browser SSE Implementation Differences**
   - Risk: Different browsers handle SSE differently
   - Mitigation: Test in multiple browsers, use EventSource polyfill if needed

2. **Network Connectivity Issues**
   - Risk: Flaky network causing test failures
   - Mitigation: Implement proper retry logic in tests

## Expected Outcomes

### Success Criteria
1. âœ… `/api/sessions/{id}/activity` returns proper activity events
2. âœ… Task execution no longer times out on the API level
3. âœ… Real-time task status updates work end-to-end
4. âœ… Multiple concurrent SSE connections work reliably  
5. âœ… Frontend hooks properly handle reconnection and event replay
6. âœ… All existing tests continue to pass (108+ backend tests)
7. âœ… Clean clippy run with `-D warnings`

### Performance Targets
- SSE connection establishment: < 100ms
- Event delivery latency: < 50ms
- Support for 20+ concurrent SSE connections
- Task execution API response: < 1 second (returns 202 Accepted)

### Deliverables
1. **Fixed SSE Endpoints** - Session activity and global event streams working properly
2. **Comprehensive Integration Tests** - Full task lifecycle with SSE monitoring
3. **Performance Validation** - Concurrent connection handling verified
4. **Updated Documentation** - AGENTS.md reflects SSE testing status
5. **Frontend Validation** - UI real-time updates working properly

## Next Steps After Completion

1. **Feature 4 Completion** - Continue WebSocket code cleanup
2. **Feature 5 Implementation** - Complete documentation & testing phase
3. **Production Readiness** - Implement monitoring and alerting for SSE health
4. **Load Testing** - More comprehensive performance testing with realistic loads

---

*Generated: 2025-01-01T01:36:13Z*  
*Task ID: 9976ffdf-9ff8-44f7-85c4-b71602352831*