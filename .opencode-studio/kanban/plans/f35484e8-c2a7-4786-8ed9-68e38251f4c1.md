# Implementation Plan: Activity Test - Say Hello

**Task ID:** f35484e8-c2a7-4786-8ed9-68e38251f4c1  
**Title:** Activity Test  
**Description:** Say hello  
**Plan Generated:** 2025-01-01 01:36:13  
**Estimated Complexity:** S (Small)

---

## 1. Technical Analysis

### Purpose & Context
This task serves as a lightweight integration test for the OpenCode Studio orchestration pipeline. While the surface requirement is simple ("say hello"), the underlying goal is to validate:

- Task lifecycle execution (TODO → PLANNING → IN_PROGRESS → DONE)
- OpenCode session creation and management
- File system operations within the workspace
- Status tracking and event emission
- VCS integration (Jujutsu/Git)

### System Components Involved
- **Orchestrator**: Task state machine and execution logic
- **OpenCode Client**: Session creation and prompt execution  
- **VCS Workspace**: Version control operations
- **Event Bus**: Status change notifications
- **Database**: Task and session persistence
- **File Manager**: Plan/review file creation

### Implementation Strategy
Create a minimal, observable change that exercises the full pipeline without adding complexity. The "hello" output will be implemented as:
1. A simple text file creation or modification
2. A log entry or comment in existing code
3. A basic test file addition

---

## 2. Files to Modify/Create

### Primary Target (Choose One)
```
Option A: Create new file
├── hello.txt                    # Simple text file with greeting
└── .opencode-studio/
    └── activity-test-output.log # Execution log

Option B: Modify existing file  
├── crates/server/src/main.rs    # Add hello log on startup
└── README.md                    # Add activity test section

Option C: Create test file
├── crates/core/src/lib.rs       # Add hello() function
└── crates/core/src/tests/       # Add integration test
```

### Supporting Files (Auto-generated)
```
.opencode-studio/
├── kanban/
│   ├── plans/f35484e8-c2a7-4786-8ed9-68e38251f4c1.md    # This file
│   └── reviews/f35484e8-c2a7-4786-8ed9-68e38251f4c1.md  # Post-implementation
└── sessions/
    └── {session-id}.json        # OpenCode session metadata
```

---

## 3. Step-by-Step Implementation

### Phase 1: Pre-Implementation Setup
1. **Workspace Validation**
   - Verify current working directory is clean (`jj status` / `git status`)
   - Ensure no conflicting changes in progress
   - Validate OpenCode connection is active

2. **Session Initialization** 
   - Create OpenCode session via `/api/sessions`
   - Initialize workspace if needed
   - Set task status to `IN_PROGRESS`

### Phase 2: Core Implementation
3. **Choose Implementation Path**
   - **Recommended**: Option A (new file) - least invasive
   - Create `hello.txt` with content: "Hello from OpenCode Studio Activity Test!"
   - Add timestamp and task ID for traceability

4. **File Operations**
   ```bash
   echo "Hello from OpenCode Studio Activity Test!" > hello.txt
   echo "Generated: $(date)" >> hello.txt
   echo "Task ID: f35484e8-c2a7-4786-8ed9-68e38251f4c1" >> hello.txt
   ```

5. **Verification Steps**
   - Confirm file creation successful
   - Validate file content matches expectations
   - Check file permissions and ownership

### Phase 3: Integration Validation
6. **VCS Operations**
   - Stage changes (`jj add` / `git add`)
   - Create commit with descriptive message
   - Verify workspace status clean

7. **Event Emission**
   - Emit `task.file_created` event
   - Emit `task.status_changed` to `AI_REVIEW`
   - Log activity to session activity stream

8. **Session Completion**
   - Mark OpenCode session as completed
   - Update task status to `AI_REVIEW` → `REVIEW` → `DONE`
   - Generate review file with implementation summary

---

## 4. Potential Risks & Mitigations

### Risk 1: OpenCode Session Timeout
**Impact:** Medium - Task may remain in `IN_PROGRESS` state
**Probability:** Medium (known issue from previous testing)
**Mitigation:** 
- Implement 30-second timeout handling
- Add retry logic for failed sessions
- Graceful fallback to manual completion

### Risk 2: File System Permissions
**Impact:** Low - File creation might fail
**Probability:** Low
**Mitigation:**
- Validate write permissions before execution
- Use temporary file + rename pattern
- Clear error messaging for permission issues

### Risk 3: VCS Conflicts
**Impact:** Medium - Workspace state corruption
**Probability:** Low  
**Mitigation:**
- Pre-check for clean workspace state
- Use atomic operations where possible
- Implement rollback on failure

### Risk 4: Event Bus Failure
**Impact:** Low - Silent status update failures
**Probability:** Low
**Mitigation:**
- Add event emission verification
- Implement retry mechanism for critical events
- Log all event attempts for debugging

---

## 5. Success Criteria

### Primary Objectives
- [ ] Task transitions through complete lifecycle (TODO → DONE)
- [ ] OpenCode session created and completed successfully  
- [ ] "Hello" output generated and persisted
- [ ] No errors in application logs
- [ ] VCS workspace remains clean

### Secondary Objectives  
- [ ] SSE events emitted for status changes
- [ ] Session activity logged to database
- [ ] Review file generated with implementation details
- [ ] Execution time < 30 seconds (within timeout window)

### Verification Commands
```bash
# Check file creation
ls -la hello.txt
cat hello.txt

# Verify VCS status  
jj status  # or git status

# Check database state
sqlite3 studio.db "SELECT status FROM tasks WHERE id = 'f35484e8-c2a7-4786-8ed9-68e38251f4c1';"

# Validate session completion
sqlite3 studio.db "SELECT status FROM sessions WHERE task_id = 'f35484e8-c2a7-4786-8ed9-68e38251f4c1';"
```

---

## 6. Estimated Complexity: S (Small)

**Rationale:**
- Minimal code changes required (single file creation)
- Well-understood system components
- Low risk of breaking existing functionality
- Fast execution time expected
- Clear success/failure indicators

**Time Estimate:** 5-10 minutes for execution + validation

**Dependencies:** None (self-contained test)

---

## 7. Post-Implementation Notes

This task primarily serves as a system health check rather than feature development. Success indicates:
- OpenCode integration is functional
- Task lifecycle automation works end-to-end  
- VCS workspace management operates correctly
- Event system and database persistence are stable

Failure modes will help identify specific areas needing attention in the OpenCode Studio pipeline.

---

**Plan Status:** Ready for Implementation  
**Next Phase:** Await execution trigger via task management system